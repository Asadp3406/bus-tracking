<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartBus - Complete Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; }
        .bus-marker { background: #10b981; border: 3px solid white; border-radius: 50%; width: 20px; height: 20px; }
        .stop-marker { background: #6b7280; border: 2px solid white; border-radius: 50%; width: 12px; height: 12px; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .user-tab { cursor: pointer; transition: all 0.3s; }
        .user-tab.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold">🚌 SmartBus Tracker</h1>
                    <span class="ml-3 px-2 py-1 bg-green-500 text-white text-xs font-medium rounded-full" id="systemStatus">
                        SYSTEM ONLINE
                    </span>
                </div>
                
                <!-- User Type Selector -->
                <div class="flex bg-blue-700 rounded-lg p-1">
                    <button onclick="switchUserType('passenger')" class="user-tab px-4 py-2 rounded-md text-sm font-medium active" id="passengerTab">
                        👥 Passenger
                    </button>
                    <button onclick="switchUserType('admin')" class="user-tab px-4 py-2 rounded-md text-sm font-medium" id="adminTab">
                        🔧 Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Passenger Interface -->
    <div id="passengerInterface" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">🔍 Find Your Bus</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">From</label>
                    <input type="text" id="fromStop" placeholder="Enter starting point" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <div id="fromSuggestions" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
                </div>
                
                <div class="relative">
                    <label class="block text-sm font-medium text-gray-700 mb-2">To</label>
                    <input type="text" id="toStop" placeholder="Enter destination" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <div id="toSuggestions" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden max-h-48 overflow-y-auto shadow-lg"></div>
                </div>
                
                <div class="flex items-end">
                    <button onclick="searchRoutes()" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium">
                        🔍 Search Routes
                    </button>
                </div>
            </div>

            <!-- Quick Search Options -->
            <div class="flex flex-wrap gap-2">
                <span class="text-sm text-gray-600">Quick searches:</span>
                <button onclick="quickSearch('Katraj', 'Shivajinagar')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                    Katraj → Shivajinagar
                </button>
                <button onclick="quickSearch('Hadapsar', 'Pimpri')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-gray-200">
                    Hadapsar → Pimpri
                </button>
            </div>
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4">🚌 Available Routes</h3>
            <div id="routesList" class="space-y-4"></div>
        </div>
    </div> 
   <!-- Admin Interface -->
    <div id="adminInterface" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Admin Navigation -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-wrap gap-2">
                <button onclick="showAdminSection('dashboard')" class="admin-nav-btn bg-blue-100 text-blue-700 px-4 py-2 rounded-lg font-medium">
                    📊 Dashboard
                </button>
                <button onclick="showAdminSection('buses')" class="admin-nav-btn text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">
                    🚌 Buses
                </button>
                <button onclick="showAdminSection('routes')" class="admin-nav-btn text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">
                    🗺️ Routes
                </button>
                <button onclick="showAdminSection('drivers')" class="admin-nav-btn text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-lg font-medium">
                    👨‍💼 Drivers
                </button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="admin-section">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Admin Dashboard</h2>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-500 text-white">🚌</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Active Buses</p>
                            <p class="text-2xl font-bold text-gray-900" id="activeBusesCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-500 text-white">🗺️</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Routes</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalRoutesCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-500 text-white">👥</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Total Passengers</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalPassengersCount">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-500 text-white">⚡</div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Avg Speed</p>
                            <p class="text-2xl font-bold text-gray-900" id="avgSpeedCount">0 km/h</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bus Management -->
        <div id="admin-buses" class="admin-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-900">Bus Management</h2>
                <button onclick="openModal('bus')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                    + Add New Bus
                </button>
            </div>
            
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bus ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Occupancy</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="busesTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <!-- Route Management -->
        <div id="admin-routes" class="admin-section hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-900">Route Management</h2>
                <button onclick="openModal('route')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                    + Add New Route
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="routesGrid"></div>
        </div>

        <!-- Driver Management -->
        <div id="admin-drivers" class="admin-section hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Driver Management</h2>
            
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Driver</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bus</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Route</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                        </tr>
                    </thead>
                    <tbody id="driversTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Shared Live Map -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">🗺️ Live Bus Tracking</h3>
                <div class="flex space-x-2">
                    <button onclick="findNearbyBuses()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                        📍 Find Nearby
                    </button>
                    <button onclick="showAllRoutes()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                        🗺️ Show All Routes
                    </button>
                </div>
            </div>
            <div id="map"></div>
        </div>

        <!-- Live Bus Information -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Nearby Buses -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">🚌 Live Buses</h3>
                <div id="nearbyBusesList" class="space-y-3"></div>
            </div>

            <!-- Bus Arrival Times -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">⏰ Next Arrivals</h3>
                <div class="mb-4">
                    <select id="stopSelector" onchange="getStopArrivals()" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">Select a bus stop</option>
                    </select>
                </div>
                <div id="arrivalsList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">Select a bus stop to see arrival times</p>
                </div>
            </div>
        </div>
    </div>    <!-- 
Modal for Adding/Editing -->
    <div id="modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="modalTitle">Add New Item</h3>
                <form id="modalForm">
                    <div id="modalContent"></div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Save
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bus Details Modal -->
    <div id="busModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900" id="busModalTitle">Bus Details</h3>
                    <button onclick="closeBusModal()" class="text-gray-400 hover:text-gray-600">✕</button>
                </div>
                <div id="busModalContent"></div>
                <div class="mt-6 flex space-x-3">
                    <button onclick="trackBus()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                        🎯 Track Bus
                    </button>
                    <button onclick="setNotification()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                        🔔 Notify Me
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Global variables
        let buses = [];
        let routes = [];
        let drivers = [];
        let stops = [];
        let map = null;
        let busMarkers = {};
        let userLocation = null;
        let selectedBus = null;
        let currentUserType = 'passenger';
        const API_BASE_URL = 'http://localhost:3000/api';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚌 SmartBus Dashboard Initializing...');
            initializeMap();
            fetchData();
            setupSearchAutocomplete();
            getUserLocation();
            setInterval(fetchData, 10000); // Refresh every 10 seconds
        });

        // Initialize map
        function initializeMap() {
            map = L.map('map').setView([18.5204, 73.8567], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            console.log('✅ Map initialized');
        }

        // Fetch data from API
        async function fetchData() {
            try {
                console.log('📡 Fetching data from API...');
                const [busesRes, routesRes, driversRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/buses`).catch(() => ({ json: () => ({ data: [] }) })),
                    fetch(`${API_BASE_URL}/routes`).catch(() => ({ json: () => ({ data: [] }) })),
                    fetch(`${API_BASE_URL}/drivers`).catch(() => ({ json: () => ({ data: [] }) }))
                ]);

                buses = (await busesRes.json()).data || [];
                routes = (await routesRes.json()).data || [];
                drivers = (await driversRes.json()).data || [];

                console.log(`✅ Data loaded: ${buses.length} buses, ${routes.length} routes, ${drivers.length} drivers`);

                updateMap();
                updateNearbyBuses();
                populateStopSelector();
                
                if (currentUserType === 'admin') {
                    updateAdminDashboard();
                    updateBusesTable();
                    updateRoutesGrid();
                    updateDriversTable();
                }
            } catch (error) {
                console.error('❌ Error fetching data:', error);
                // Use sample data if API fails
                loadSampleData();
            }
        }

        // Load sample data if API is not available
        function loadSampleData() {
            console.log('📝 Loading sample data...');
            buses = [
                {
                    id: 'MH12-AB-1234',
                    routeId: 1,
                    route: 'Route 1: Katraj to Shivajinagar',
                    lat: 18.5074,
                    lng: 73.8077,
                    speed: 35,
                    nextStop: 'Swargate',
                    eta: 5,
                    passengers: 42,
                    capacity: 60,
                    status: 'active',
                    driver: { name: 'Rajesh Kumar', phone: '+91-9876543210' },
                    busType: 'AC',
                    fare: 15
                },
                {
                    id: 'MH12-CD-5678',
                    routeId: 2,
                    route: 'Route 2: Hadapsar to Pimpri',
                    lat: 18.5204,
                    lng: 73.8567,
                    speed: 28,
                    nextStop: 'Pune Station',
                    eta: 8,
                    passengers: 38,
                    capacity: 60,
                    status: 'active',
                    driver: { name: 'Amit Sharma', phone: '+91-9876543211' },
                    busType: 'Non-AC',
                    fare: 10
                }
            ];

            routes = [
                {
                    id: 1,
                    name: 'Route 1: Katraj to Shivajinagar',
                    routeNumber: '1A',
                    color: '#10b981',
                    stops: [
                        { id: 1, name: 'Katraj', lat: 18.4575, lng: 73.8677 },
                        { id: 2, name: 'Swargate', lat: 18.5074, lng: 73.8077 },
                        { id: 3, name: 'Pune Station', lat: 18.5204, lng: 73.8567 },
                        { id: 4, name: 'Shivajinagar', lat: 18.5308, lng: 73.8474 }
                    ]
                },
                {
                    id: 2,
                    name: 'Route 2: Hadapsar to Pimpri',
                    routeNumber: '2B',
                    color: '#3b82f6',
                    stops: [
                        { id: 5, name: 'Hadapsar', lat: 18.5018, lng: 73.9200 },
                        { id: 6, name: 'Koregaon Park', lat: 18.5362, lng: 73.8941 },
                        { id: 7, name: 'Pune Station', lat: 18.5204, lng: 73.8567 },
                        { id: 8, name: 'Pimpri', lat: 18.5433, lng: 73.8097 }
                    ]
                }
            ];

            updateMap();
            updateNearbyBuses();
            populateStopSelector();
        }

        // Switch between user types
        function switchUserType(type) {
            currentUserType = type;
            
            // Update tab appearance
            document.querySelectorAll('.user-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(type + 'Tab').classList.add('active');
            
            // Show/hide interfaces
            if (type === 'passenger') {
                document.getElementById('passengerInterface').classList.remove('hidden');
                document.getElementById('adminInterface').classList.add('hidden');
            } else {
                document.getElementById('passengerInterface').classList.add('hidden');
                document.getElementById('adminInterface').classList.remove('hidden');
                updateAdminDashboard();
            }
            
            console.log(`👤 Switched to ${type} mode`);
        }

        // Get user location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    userLocation = [position.coords.latitude, position.coords.longitude];
                    
                    L.marker(userLocation, {
                        icon: L.divIcon({
                            className: 'user-location',
                            html: '<div style="width: 16px; height: 16px; background: #3b82f6; border: 2px solid white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                            iconSize: [16, 16]
                        })
                    }).addTo(map).bindPopup('📍 Your Location');
                    
                    console.log('📍 User location obtained');
                });
            }
        }    
    // Update map with buses and stops
        function updateMap() {
            // Clear existing bus markers
            Object.values(busMarkers).forEach(marker => map.removeLayer(marker));
            busMarkers = {};

            // Add bus markers
            buses.forEach(bus => {
                if (bus.lat && bus.lng) {
                    const marker = L.marker([bus.lat, bus.lng], {
                        icon: L.divIcon({
                            className: 'bus-marker',
                            html: `<div class="bus-marker" style="background: ${getRouteColor(bus.routeId)};"></div>`,
                            iconSize: [20, 20]
                        })
                    }).addTo(map);

                    marker.bindPopup(`
                        <div class="text-center">
                            <h4 class="font-bold">${bus.id}</h4>
                            <p class="text-sm">${bus.route}</p>
                            <p class="text-sm">Next: ${bus.nextStop} (${Math.round(bus.eta)} min)</p>
                            <p class="text-sm">Occupancy: ${bus.passengers}/${bus.capacity}</p>
                            <button onclick="showBusDetails('${bus.id}')" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                View Details
                            </button>
                        </div>
                    `);

                    busMarkers[bus.id] = marker;
                }
            });

            // Add stop markers
            routes.forEach(route => {
                if (route.stops) {
                    route.stops.forEach(stop => {
                        L.marker([stop.lat, stop.lng], {
                            icon: L.divIcon({
                                className: 'stop-marker',
                                html: '<div class="stop-marker"></div>',
                                iconSize: [12, 12]
                            })
                        }).addTo(map).bindPopup(`
                            <div class="text-center">
                                <h4 class="font-bold">${stop.name}</h4>
                                <p class="text-sm">Bus Stop</p>
                                <button onclick="getStopETA(${stop.id})" class="mt-2 px-3 py-1 bg-green-600 text-white rounded text-sm">
                                    Check Arrivals
                                </button>
                            </div>
                        `);
                    });
                }
            });
        }

        // Update nearby buses list
        function updateNearbyBuses() {
            const list = document.getElementById('nearbyBusesList');
            list.innerHTML = '';

            buses.slice(0, 5).forEach(bus => {
                const occupancyRate = (bus.passengers / bus.capacity * 100).toFixed(0);
                const card = document.createElement('div');
                card.className = 'p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer';
                card.onclick = () => showBusDetails(bus.id);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-medium">${bus.id}</h4>
                            <p class="text-sm text-gray-600">${bus.route.split(':')[1] || bus.route}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            bus.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">${bus.status}</span>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <div class="flex justify-between">
                            <span>Next Stop:</span>
                            <span class="font-medium">${bus.nextStop} (${Math.round(bus.eta)} min)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Occupancy:</span>
                            <span class="font-medium ${occupancyRate < 50 ? 'text-green-600' : occupancyRate < 80 ? 'text-yellow-600' : 'text-red-600'}">
                                ${occupancyRate}% (${bus.passengers}/${bus.capacity})
                            </span>
                        </div>
                    </div>
                `;
                
                list.appendChild(card);
            });
        }

        // Setup search autocomplete
        function setupSearchAutocomplete() {
            const fromInput = document.getElementById('fromStop');
            const toInput = document.getElementById('toStop');
            
            fromInput.addEventListener('input', (e) => showSuggestions(e.target.value, 'fromSuggestions'));
            toInput.addEventListener('input', (e) => showSuggestions(e.target.value, 'toSuggestions'));
        }

        // Show search suggestions
        function showSuggestions(query, containerId) {
            const container = document.getElementById(containerId);
            
            if (query.length < 2) {
                container.classList.add('hidden');
                return;
            }

            const allStops = [];
            routes.forEach(route => {
                if (route.stops) {
                    route.stops.forEach(stop => {
                        if (!allStops.find(s => s.id === stop.id)) {
                            allStops.push(stop);
                        }
                    });
                }
            });

            const filtered = allStops.filter(stop => 
                stop.name.toLowerCase().includes(query.toLowerCase())
            );

            container.innerHTML = '';
            filtered.slice(0, 5).forEach(stop => {
                const div = document.createElement('div');
                div.className = 'p-2 hover:bg-gray-100 cursor-pointer';
                div.textContent = stop.name;
                div.onclick = () => {
                    if (containerId === 'fromSuggestions') {
                        document.getElementById('fromStop').value = stop.name;
                    } else {
                        document.getElementById('toStop').value = stop.name;
                    }
                    container.classList.add('hidden');
                };
                container.appendChild(div);
            });

            container.classList.remove('hidden');
        }

        // Search routes
        function searchRoutes() {
            const from = document.getElementById('fromStop').value;
            const to = document.getElementById('toStop').value;

            if (!from || !to) {
                alert('Please enter both starting point and destination');
                return;
            }

            const matchingRoutes = routes.filter(route => {
                if (!route.stops) return false;
                const hasFrom = route.stops.some(stop => stop.name.toLowerCase().includes(from.toLowerCase()));
                const hasTo = route.stops.some(stop => stop.name.toLowerCase().includes(to.toLowerCase()));
                return hasFrom && hasTo;
            });

            displaySearchResults(matchingRoutes, from, to);
        }

        // Display search results
        function displaySearchResults(matchingRoutes, from, to) {
            const resultsContainer = document.getElementById('searchResults');
            const routesList = document.getElementById('routesList');

            if (matchingRoutes.length === 0) {
                routesList.innerHTML = '<p class="text-gray-500 text-center py-4">No direct routes found between these stops.</p>';
            } else {
                routesList.innerHTML = '';
                matchingRoutes.forEach(route => {
                    const routeBuses = buses.filter(bus => bus.routeId === route.id && bus.status === 'active');
                    
                    const card = document.createElement('div');
                    card.className = 'border border-gray-200 rounded-lg p-4';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-lg">${route.routeNumber}</h4>
                                <p class="text-gray-600">${route.name}</p>
                            </div>
                            <div class="w-4 h-4 rounded-full" style="background-color: ${route.color}"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                            <div>
                                <span class="text-gray-500">Active Buses:</span>
                                <span class="font-medium ml-1">${routeBuses.length}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Stops:</span>
                                <span class="font-medium ml-1">${route.stops?.length || 0}</span>
                            </div>
                        </div>
                        <button onclick="showRouteOnMap(${route.id})" class="w-full bg-blue-100 text-blue-700 py-2 rounded hover:bg-blue-200">
                            📍 Show on Map
                        </button>
                    `;
                    routesList.appendChild(card);
                });
            }

            resultsContainer.classList.remove('hidden');
        }

        // Quick search
        function quickSearch(from, to) {
            document.getElementById('fromStop').value = from;
            document.getElementById('toStop').value = to;
            searchRoutes();
        }

        // Populate stop selector
        function populateStopSelector() {
            const selector = document.getElementById('stopSelector');
            selector.innerHTML = '<option value="">Select a bus stop</option>';

            const allStops = [];
            routes.forEach(route => {
                if (route.stops) {
                    route.stops.forEach(stop => {
                        if (!allStops.find(s => s.id === stop.id)) {
                            allStops.push(stop);
                        }
                    });
                }
            });

            allStops.forEach(stop => {
                const option = document.createElement('option');
                option.value = stop.id;
                option.textContent = stop.name;
                selector.appendChild(option);
            });
        } 
       // Admin functions
        function updateAdminDashboard() {
            document.getElementById('activeBusesCount').textContent = buses.filter(bus => bus.status === 'active').length;
            document.getElementById('totalRoutesCount').textContent = routes.length;
            document.getElementById('totalPassengersCount').textContent = buses.reduce((sum, bus) => sum + bus.passengers, 0);
            document.getElementById('avgSpeedCount').textContent = Math.round(buses.reduce((sum, bus) => sum + bus.speed, 0) / buses.length) + ' km/h';
        }

        function showAdminSection(section) {
            document.querySelectorAll('.admin-section').forEach(sec => sec.classList.add('hidden'));
            document.getElementById('admin-' + section).classList.remove('hidden');
            
            document.querySelectorAll('.admin-nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('text-gray-600');
            });
            event.target.classList.add('bg-blue-100', 'text-blue-700');
            event.target.classList.remove('text-gray-600');
        }

        function updateBusesTable() {
            const tbody = document.getElementById('busesTableBody');
            tbody.innerHTML = '';

            buses.forEach(bus => {
                const occupancyRate = (bus.passengers / bus.capacity * 100).toFixed(1);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${bus.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bus.route.split(':')[1] || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bus.driver?.name || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            bus.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                        }">
                            ${bus.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${bus.passengers}/${bus.capacity} (${occupancyRate}%)
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editBus('${bus.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                        <button onclick="deleteBus('${bus.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateRoutesGrid() {
            const grid = document.getElementById('routesGrid');
            grid.innerHTML = '';

            routes.forEach(route => {
                const routeBuses = buses.filter(bus => bus.routeId === route.id);
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow p-6';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">${route.routeNumber}</h3>
                        <div class="w-4 h-4 rounded-full" style="background-color: ${route.color}"></div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">${route.name}</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Active Buses:</span>
                            <span class="font-medium">${routeBuses.filter(bus => bus.status === 'active').length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Total Stops:</span>
                            <span class="font-medium">${route.stops?.length || 0}</span>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editRoute(${route.id})" class="flex-1 bg-blue-100 text-blue-700 px-3 py-2 rounded text-sm hover:bg-blue-200">
                            Edit
                        </button>
                        <button onclick="deleteRoute(${route.id})" class="flex-1 bg-red-100 text-red-700 px-3 py-2 rounded text-sm hover:bg-red-200">
                            Delete
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function updateDriversTable() {
            const tbody = document.getElementById('driversTableBody');
            tbody.innerHTML = '';

            buses.forEach(bus => {
                if (bus.driver) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${bus.driver.name}</div>
                            <div class="text-sm text-gray-500">License: ${bus.driver.license || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bus.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bus.route.split(':')[1] || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                bus.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            }">
                                ${bus.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${bus.driver.phone}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }

        // Modal functions
        function openModal(type, item = null) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            title.textContent = item ? `Edit ${type}` : `Add New ${type}`;

            if (type === 'bus') {
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bus ID</label>
                            <input type="text" name="id" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   placeholder="e.g., MH12-AB-1234" ${item ? 'disabled' : ''} value="${item?.id || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Route</label>
                            <select name="routeId" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="">Select Route</option>
                                ${routes.map(route => `
                                    <option value="${route.id}" ${item?.routeId === route.id ? 'selected' : ''}>
                                        ${route.routeNumber} - ${route.name}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Bus Type</label>
                            <select name="busType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="AC" ${item?.busType === 'AC' ? 'selected' : ''}>AC</option>
                                <option value="Non-AC" ${item?.busType === 'Non-AC' ? 'selected' : ''}>Non-AC</option>
                                <option value="Electric" ${item?.busType === 'Electric' ? 'selected' : ''}>Electric</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Capacity</label>
                            <input type="number" name="capacity" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   min="20" max="100" value="${item?.capacity || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Driver Name</label>
                            <input type="text" name="driverName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   value="${item?.driver?.name || ''}">
                        </div>
                    </div>
                `;
            } else if (type === 'route') {
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Route Name</label>
                            <input type="text" name="name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   placeholder="e.g., Route 1: Katraj to Shivajinagar" value="${item?.name || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Route Number</label>
                            <input type="text" name="routeNumber" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   placeholder="e.g., 1A" value="${item?.routeNumber || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Operator</label>
                            <input type="text" name="operator" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" 
                                   value="${item?.operator || 'PMPML'}">
                        </div>
                    </div>
                `;
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        // Bus details modal
        function showBusDetails(busId) {
            const bus = buses.find(b => b.id === busId);
            if (!bus) return;

            selectedBus = bus;
            const modal = document.getElementById('busModal');
            const title = document.getElementById('busModalTitle');
            const content = document.getElementById('busModalContent');

            title.textContent = `Bus ${bus.id}`;
            
            const occupancyRate = (bus.passengers / bus.capacity * 100).toFixed(1);
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-bold">${bus.route}</h4>
                        <div class="flex items-center mt-2">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${bus.busType}</span>
                            <span class="ml-2 text-sm">₹${bus.fare}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${Math.round(bus.eta)}</div>
                            <div class="text-sm text-gray-600">Minutes to ${bus.nextStop}</div>
                        </div>
                        <div class="text-center p-3 bg-gray-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${bus.speed}</div>
                            <div class="text-sm text-gray-600">km/h</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-medium mb-2">Occupancy</h5>
                        <div class="flex justify-between items-center mb-2">
                            <span>${bus.passengers}/${bus.capacity} passengers</span>
                            <span class="font-medium">${occupancyRate}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${
                                occupancyRate < 50 ? 'bg-green-500' :
                                occupancyRate < 80 ? 'bg-yellow-500' : 'bg-red-500'
                            } h-2 rounded-full" style="width: ${occupancyRate}%"></div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h5 class="font-medium mb-2">Driver Information</h5>
                        <p>${bus.driver?.name || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${bus.driver?.phone || 'N/A'}</p>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeBusModal() {
            document.getElementById('busModal').classList.remove('active');
            selectedBus = null;
        }

        function trackBus() {
            if (!selectedBus) return;
            
            map.setView([selectedBus.lat, selectedBus.lng], 16);
            busMarkers[selectedBus.id].openPopup();
            closeBusModal();
        }

        function setNotification() {
            if (!selectedBus) return;
            
            alert(`✅ Notification set! You'll be alerted when ${selectedBus.id} is approaching your stop.`);
            closeBusModal();
        }

        // Utility functions
        function findNearbyBuses() {
            if (!userLocation) {
                alert('Please enable location services to find nearby buses.');
                return;
            }

            let nearestBus = null;
            let minDistance = Infinity;

            buses.forEach(bus => {
                const distance = calculateDistance(userLocation[0], userLocation[1], bus.lat, bus.lng);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestBus = bus;
                }
            });

            if (nearestBus) {
                map.setView([nearestBus.lat, nearestBus.lng], 16);
                busMarkers[nearestBus.id].openPopup();
            }
        }

        function showAllRoutes() {
            const allPoints = [];
            routes.forEach(route => {
                if (route.stops) {
                    route.stops.forEach(stop => {
                        allPoints.push([stop.lat, stop.lng]);
                    });
                }
            });

            if (allPoints.length > 0) {
                const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function showRouteOnMap(routeId) {
            const route = routes.find(r => r.id === routeId);
            if (route && route.stops) {
                const bounds = L.latLngBounds(route.stops.map(stop => [stop.lat, stop.lng]));
                map.fitBounds(bounds.pad(0.1));
            }
        }

        function getRouteColor(routeId) {
            const route = routes.find(r => r.id === routeId);
            return route ? route.color : '#6b7280';
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // CRUD operations (simplified for demo)
        async function deleteBus(busId) {
            if (confirm('Are you sure you want to delete this bus?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/buses/${busId}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('✅ Bus deleted successfully!');
                        fetchData();
                    }
                } catch (error) {
                    alert('❌ Error deleting bus');
                }
            }
        }

        function editBus(busId) {
            const bus = buses.find(b => b.id === busId);
            openModal('bus', bus);
        }

        function editRoute(routeId) {
            const route = routes.find(r => r.id === routeId);
            openModal('route', route);
        }

        async function deleteRoute(routeId) {
            if (confirm('Are you sure you want to delete this route?')) {
                try {
                    const response = await fetch(`${API_BASE_URL}/routes/${routeId}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('✅ Route deleted successfully!');
                        fetchData();
                    }
                } catch (error) {
                    alert('❌ Error deleting route');
                }
            }
        }

        async function getStopArrivals() {
            const stopId = document.getElementById('stopSelector').value;
            if (!stopId) return;

            try {
                const response = await fetch(`${API_BASE_URL}/stops/${stopId}/eta`);
                const data = await response.json();

                const arrivalsList = document.getElementById('arrivalsList');
                
                if (data.success && data.data.length > 0) {
                    arrivalsList.innerHTML = '';
                    data.data.forEach(bus => {
                        const card = document.createElement('div');
                        card.className = 'p-3 border border-gray-200 rounded-lg';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium">${bus.routeNumber} - ${bus.busId}</h4>
                                    <p class="text-sm text-gray-600">${bus.busType}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-green-600">${bus.eta} min</span>
                                    <p class="text-xs text-gray-500">${bus.passengers}/${bus.capacity} passengers</p>
                                </div>
                            </div>
                        `;
                        arrivalsList.appendChild(card);
                    });
                } else {
                    arrivalsList.innerHTML = '<p class="text-gray-500 text-center py-4">No buses approaching this stop currently.</p>';
                }
            } catch (error) {
                console.error('Error fetching arrivals:', error);
                arrivalsList.innerHTML = '<p class="text-gray-500 text-center py-4">Unable to fetch arrival times.</p>';
            }
        }

        function getStopETA(stopId) {
            document.getElementById('stopSelector').value = stopId;
            getStopArrivals();
        }

        // Form submission
        document.getElementById('modalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch(`${API_BASE_URL}/buses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('✅ Item saved successfully!');
                    closeModal();
                    fetchData();
                } else {
                    const error = await response.json();
                    alert('❌ Error: ' + error.message);
                }
            } catch (error) {
                alert('❌ Error saving item');
            }
        });

        console.log('🚌 SmartBus Dashboard Ready!');
    </script>
</body>
</html>